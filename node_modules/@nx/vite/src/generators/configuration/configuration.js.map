{"version":3,"sources":["../../../../../../packages/vite/src/generators/configuration/configuration.ts"],"sourcesContent":["import {\n  convertNxGenerator,\n  formatFiles,\n  GeneratorCallback,\n  joinPathFragments,\n  readProjectConfiguration,\n  runTasksInSerial,\n  Tree,\n  updateJson,\n} from '@nx/devkit';\n\nimport {\n  addOrChangeBuildTarget,\n  addOrChangeServeTarget,\n  addPreviewTarget,\n  createOrEditViteConfig,\n  deleteWebpackConfig,\n  editTsConfig,\n  findExistingTargetsInProject,\n  handleUnknownExecutors,\n  handleUnsupportedUserProvidedTargets,\n  moveAndEditIndexHtml,\n  TargetFlags,\n  UserProvidedTargetName,\n} from '../../utils/generator-utils';\n\nimport initGenerator from '../init/init';\nimport vitestGenerator from '../vitest/vitest-generator';\nimport { ViteConfigurationGeneratorSchema } from './schema';\n\nexport async function viteConfigurationGenerator(\n  tree: Tree,\n  schema: ViteConfigurationGeneratorSchema\n) {\n  const tasks: GeneratorCallback[] = [];\n\n  const { targets, projectType, root } = readProjectConfiguration(\n    tree,\n    schema.project\n  );\n  let buildTargetName = 'build';\n  let serveTargetName = 'serve';\n  let testTargetName = 'test';\n\n  schema.includeLib ??= projectType === 'library';\n\n  // Setting default to jsdom since it is the most common use case (React, Web).\n  // The @nx/js:lib generator specifically sets this to node to be more generic.\n  schema.testEnvironment ??= 'jsdom';\n\n  /**\n   * This is for when we are converting an existing project\n   * to use the vite executors.\n   */\n  let projectAlreadyHasViteTargets: TargetFlags = {};\n\n  if (!schema.newProject) {\n    const userProvidedTargetName: UserProvidedTargetName = {\n      build: schema.buildTarget,\n      serve: schema.serveTarget,\n      test: schema.testTarget,\n    };\n\n    const {\n      validFoundTargetName,\n      projectContainsUnsupportedExecutor,\n      userProvidedTargetIsUnsupported,\n      alreadyHasNxViteTargets,\n    } = findExistingTargetsInProject(targets, userProvidedTargetName);\n    projectAlreadyHasViteTargets = alreadyHasNxViteTargets;\n    /**\n     * This means that we only found unsupported build targets in that project.\n     * The only way that buildTarget is defined, means that it is supported.\n     *\n     * If the `unsupported` flag was false, it would mean that we did not find\n     * a build target at all, so we can create a new one.\n     *\n     * So we only throw if we found a target, but it is unsupported.\n     */\n    if (!validFoundTargetName.build && projectContainsUnsupportedExecutor) {\n      throw new Error(\n        `The project ${schema.project} cannot be converted to use the @nx/vite executors.`\n      );\n    }\n\n    if (\n      alreadyHasNxViteTargets.build &&\n      (alreadyHasNxViteTargets.serve || projectType === 'library') &&\n      alreadyHasNxViteTargets.test\n    ) {\n      throw new Error(\n        `The project ${schema.project} is already configured to use the @nx/vite executors.\n        Please try a different project, or remove the existing targets \n        and re-run this generator to reset the existing Vite Configuration.\n        `\n      );\n    }\n\n    /**\n     * This means that we did not find any supported executors\n     * so we don't have any valid target names.\n     *\n     * However, the executors that we may have found are not in the\n     * list of the specifically unsupported executors either.\n     *\n     * So, we should warn the user about it.\n     */\n\n    if (\n      !projectContainsUnsupportedExecutor &&\n      !validFoundTargetName.build &&\n      !validFoundTargetName.serve &&\n      !validFoundTargetName.test\n    ) {\n      await handleUnknownExecutors(schema.project);\n    }\n\n    /**\n     * There is a possibility at this stage that the user has provided\n     * targets with unsupported executors.\n     * We keep track here of which of the targets that the user provided\n     * are unsupported.\n     * We do this with the `userProvidedTargetIsUnsupported` object,\n     * which contains flags for each target (whether it is supported or not).\n     *\n     * We also keep track of the targets that we found in the project,\n     * through the findExistingTargetsInProject function, which returns\n     * targets for build/serve/test that use supported executors, and\n     * can be converted to use the vite executors. These are the\n     * kept in the validFoundTargetName object.\n     */\n    await handleUnsupportedUserProvidedTargets(\n      userProvidedTargetIsUnsupported,\n      userProvidedTargetName,\n      validFoundTargetName\n    );\n\n    /**\n     * Once the user is at this stage, then they can go ahead and convert.\n     */\n\n    buildTargetName = validFoundTargetName.build ?? buildTargetName;\n    serveTargetName = validFoundTargetName.serve ?? serveTargetName;\n\n    if (projectType === 'application') {\n      moveAndEditIndexHtml(tree, schema, buildTargetName);\n    }\n\n    deleteWebpackConfig(\n      tree,\n      root,\n      targets?.[buildTargetName]?.options?.webpackConfig\n    );\n\n    editTsConfig(tree, schema);\n  }\n\n  const initTask = await initGenerator(tree, {\n    uiFramework: schema.uiFramework,\n    includeLib: schema.includeLib,\n    compiler: schema.compiler,\n    testEnvironment: schema.testEnvironment,\n  });\n  tasks.push(initTask);\n\n  if (!projectAlreadyHasViteTargets.build) {\n    addOrChangeBuildTarget(tree, schema, buildTargetName);\n  }\n\n  if (!schema.includeLib) {\n    if (!projectAlreadyHasViteTargets.serve) {\n      addOrChangeServeTarget(tree, schema, serveTargetName);\n    }\n    if (!projectAlreadyHasViteTargets.preview) {\n      addPreviewTarget(tree, schema, serveTargetName);\n    }\n  }\n\n  if (projectType === 'library') {\n    // update tsconfig.lib.json to include vite/client\n    updateJson(tree, joinPathFragments(root, 'tsconfig.lib.json'), (json) => {\n      if (!json.compilerOptions) {\n        json.compilerOptions = {};\n      }\n      if (!json.compilerOptions.types) {\n        json.compilerOptions.types = [];\n      }\n      if (!json.compilerOptions.types.includes('vite/client')) {\n        return {\n          ...json,\n          compilerOptions: {\n            ...json.compilerOptions,\n            types: [...json.compilerOptions.types, 'vite/client'],\n          },\n        };\n      }\n      return json;\n    });\n  }\n\n  if (schema.uiFramework === 'react') {\n    createOrEditViteConfig(\n      tree,\n      {\n        project: schema.project,\n        includeLib: schema.includeLib,\n        includeVitest: schema.includeVitest,\n        inSourceTests: schema.inSourceTests,\n        rollupOptionsExternal: [\n          `'react'`,\n          `'react-dom'`,\n          `'react/jsx-runtime'`,\n        ],\n        rollupOptionsExternalString: `\"'react', 'react-dom', 'react/jsx-runtime'\"`,\n        imports: [\n          schema.compiler === 'swc'\n            ? `import react from '@vitejs/plugin-react-swc'`\n            : `import react from '@vitejs/plugin-react'`,\n        ],\n        plugins: ['react()'],\n      },\n      false\n    );\n  } else {\n    createOrEditViteConfig(tree, schema, false, projectAlreadyHasViteTargets);\n  }\n\n  if (schema.includeVitest) {\n    const vitestTask = await vitestGenerator(tree, {\n      project: schema.project,\n      uiFramework: schema.uiFramework,\n      inSourceTests: schema.inSourceTests,\n      coverageProvider: 'c8',\n      skipViteConfig: true,\n      testTarget: testTargetName,\n      skipFormat: true,\n    });\n    tasks.push(vitestTask);\n  }\n\n  if (!schema.skipFormat) {\n    await formatFiles(tree);\n  }\n\n  return runTasksInSerial(...tasks);\n}\n\nexport default viteConfigurationGenerator;\nexport const configurationSchematic = convertNxGenerator(\n  viteConfigurationGenerator\n);\n"],"names":["viteConfigurationGenerator","configurationSchematic","tree","schema","tasks","targets","projectType","root","readProjectConfiguration","project","buildTargetName","serveTargetName","testTargetName","includeLib","testEnvironment","projectAlreadyHasViteTargets","newProject","userProvidedTargetName","build","buildTarget","serve","serveTarget","test","testTarget","validFoundTargetName","projectContainsUnsupportedExecutor","userProvidedTargetIsUnsupported","alreadyHasNxViteTargets","findExistingTargetsInProject","Error","handleUnknownExecutors","handleUnsupportedUserProvidedTargets","moveAndEditIndexHtml","deleteWebpackConfig","options","webpackConfig","editTsConfig","initTask","initGenerator","uiFramework","compiler","push","addOrChangeBuildTarget","addOrChangeServeTarget","preview","addPreviewTarget","updateJson","joinPathFragments","json","compilerOptions","types","includes","createOrEditViteConfig","includeVitest","inSourceTests","rollupOptionsExternal","rollupOptionsExternalString","imports","plugins","vitestTask","vitestGenerator","coverageProvider","skipViteConfig","skipFormat","formatFiles","runTasksInSerial","convertNxGenerator"],"mappings":"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"}