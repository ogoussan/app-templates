{"version":3,"sources":["../../../../../packages/vite/src/utils/generator-utils.ts"],"sourcesContent":["import {\n  joinPathFragments,\n  logger,\n  offsetFromRoot,\n  readJson,\n  readProjectConfiguration,\n  TargetConfiguration,\n  Tree,\n  updateProjectConfiguration,\n  writeJson,\n} from '@nx/devkit';\nimport { ViteBuildExecutorOptions } from '../executors/build/schema';\nimport { ViteDevServerExecutorOptions } from '../executors/dev-server/schema';\nimport { VitePreviewServerExecutorOptions } from '../executors/preview-server/schema';\nimport { VitestExecutorOptions } from '../executors/test/schema';\nimport { ViteConfigurationGeneratorSchema } from '../generators/configuration/schema';\nimport { ensureViteConfigIsCorrect } from './vite-config-edit-utils';\n\nexport type Target = 'build' | 'serve' | 'test' | 'preview';\nexport type TargetFlags = Partial<Record<Target, boolean>>;\nexport type UserProvidedTargetName = Partial<Record<Target, string>>;\nexport type ValidFoundTargetName = Partial<Record<Target, string>>;\n\nexport function findExistingTargetsInProject(\n  targets: {\n    [targetName: string]: TargetConfiguration;\n  },\n  userProvidedTargets?: UserProvidedTargetName\n): {\n  validFoundTargetName: ValidFoundTargetName;\n  projectContainsUnsupportedExecutor: boolean;\n  userProvidedTargetIsUnsupported: TargetFlags;\n  alreadyHasNxViteTargets: TargetFlags;\n} {\n  const output: ReturnType<typeof findExistingTargetsInProject> = {\n    validFoundTargetName: {},\n    projectContainsUnsupportedExecutor: false,\n    userProvidedTargetIsUnsupported: {},\n    alreadyHasNxViteTargets: {},\n  };\n\n  const supportedExecutors = {\n    build: [\n      '@nxext/vite:build',\n      '@nx/js:babel',\n      '@nx/js:swc',\n      '@nx/webpack:webpack',\n      '@nx/rollup:rollup',\n      '@nrwl/js:babel',\n      '@nrwl/js:swc',\n      '@nrwl/webpack:webpack',\n      '@nrwl/rollup:rollup',\n      '@nrwl/web:rollup',\n    ],\n    serve: [\n      '@nxext/vite:dev',\n      '@nx/webpack:dev-server',\n      '@nrwl/webpack:dev-server',\n    ],\n    test: ['@nx/jest:jest', '@nrwl/jest:jest', '@nxext/vitest:vitest'],\n  };\n\n  const unsupportedExecutors = [\n    '@nx/angular:ng-packagr-lite',\n    '@nx/angular:package',\n    '@nx/angular:webpack-browser',\n    '@nx/esbuild:esbuild',\n    '@nx/react-native:run-ios',\n    '@nx/react-native:start',\n    '@nx/react-native:run-android',\n    '@nx/react-native:bundle',\n    '@nx/react-native:build-android',\n    '@nx/react-native:bundle',\n    '@nx/next:build',\n    '@nx/next:server',\n    '@nx/js:tsc',\n    '@nrwl/angular:ng-packagr-lite',\n    '@nrwl/angular:package',\n    '@nrwl/angular:webpack-browser',\n    '@nrwl/esbuild:esbuild',\n    '@nrwl/react-native:run-ios',\n    '@nrwl/react-native:start',\n    '@nrwl/react-native:run-android',\n    '@nrwl/react-native:bundle',\n    '@nrwl/react-native:build-android',\n    '@nrwl/react-native:bundle',\n    '@nrwl/next:build',\n    '@nrwl/next:server',\n    '@nrwl/js:tsc',\n    '@angular-devkit/build-angular:browser',\n    '@angular-devkit/build-angular:dev-server',\n  ];\n\n  // First, we check if the user has provided a target\n  // If they have, we check if the executor the target is using is supported\n  // If it's not supported, then we set the unsupported flag to true for that target\n\n  function checkUserProvidedTarget(target: Target) {\n    if (userProvidedTargets?.[target]) {\n      if (\n        supportedExecutors[target].includes(\n          targets[userProvidedTargets[target]]?.executor\n        )\n      ) {\n        output.validFoundTargetName[target] = userProvidedTargets[target];\n      } else {\n        output.userProvidedTargetIsUnsupported[target] = true;\n      }\n    }\n  }\n\n  checkUserProvidedTarget('build');\n  checkUserProvidedTarget('serve');\n  checkUserProvidedTarget('test');\n\n  // Returns early when we have a build, serve, and test targets.\n  if (\n    output.validFoundTargetName.build &&\n    output.validFoundTargetName.serve &&\n    output.validFoundTargetName.test\n  ) {\n    return output;\n  }\n\n  // We try to find the targets that are using the supported executors\n  // for build, serve and test, since these are the ones we will be converting\n  for (const target in targets) {\n    const executorName = targets[target].executor;\n\n    const hasViteTargets = output.alreadyHasNxViteTargets;\n    hasViteTargets.build ||=\n      executorName === '@nx/vite:build' || executorName === '@nrwl/vite:build';\n    hasViteTargets.serve ||=\n      executorName === '@nx/vite:dev-server' ||\n      executorName === '@nrwl/vite:dev-server';\n    hasViteTargets.test ||=\n      executorName === '@nx/vite:test' || executorName === '@nrwl/vite:test';\n    hasViteTargets.preview ||=\n      executorName === '@nx/vite:preview-server' ||\n      executorName === '@nrwl/vite:preview-server';\n\n    const foundTargets = output.validFoundTargetName;\n    if (\n      !foundTargets.build &&\n      supportedExecutors.build.includes(executorName)\n    ) {\n      foundTargets.build = target;\n    }\n    if (\n      !foundTargets.serve &&\n      supportedExecutors.serve.includes(executorName)\n    ) {\n      foundTargets.serve = target;\n    }\n    if (!foundTargets.test && supportedExecutors.test.includes(executorName)) {\n      foundTargets.test = target;\n    }\n\n    output.projectContainsUnsupportedExecutor ||=\n      unsupportedExecutors.includes(executorName);\n  }\n\n  return output;\n}\n\nexport function addOrChangeTestTarget(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema,\n  target: string\n) {\n  const project = readProjectConfiguration(tree, options.project);\n\n  const coveragePath = joinPathFragments(\n    'coverage',\n    project.root === '.' ? options.project : project.root\n  );\n  const testOptions: VitestExecutorOptions = {\n    passWithNoTests: true,\n    // vitest runs in the project root so we have to offset to the workspaceRoot\n    reportsDirectory: joinPathFragments(\n      offsetFromRoot(project.root),\n      coveragePath\n    ),\n  };\n\n  project.targets ??= {};\n\n  if (project.targets[target]) {\n    project.targets[target].executor = '@nx/vite:test';\n    delete project.targets[target].options?.jestConfig;\n  } else {\n    project.targets[target] = {\n      executor: '@nx/vite:test',\n      outputs: ['{options.reportsDirectory}'],\n      options: testOptions,\n    };\n  }\n\n  updateProjectConfiguration(tree, options.project, project);\n}\n\nexport function addOrChangeBuildTarget(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema,\n  target: string\n) {\n  const project = readProjectConfiguration(tree, options.project);\n  const buildOptions: ViteBuildExecutorOptions = {\n    outputPath: joinPathFragments(\n      'dist',\n      project.root != '.' ? project.root : options.project\n    ),\n  };\n\n  project.targets ??= {};\n\n  if (project.targets[target]) {\n    buildOptions.fileReplacements =\n      project.targets[target].options?.fileReplacements;\n\n    if (project.targets[target].executor === '@nxext/vite:build') {\n      buildOptions.base = project.targets[target].options?.baseHref;\n      buildOptions.sourcemap = project.targets[target].options?.sourcemaps;\n    }\n    project.targets[target].options = { ...buildOptions };\n    project.targets[target].executor = '@nx/vite:build';\n  } else {\n    project.targets[target] = {\n      executor: '@nx/vite:build',\n      outputs: ['{options.outputPath}'],\n      defaultConfiguration: 'production',\n      options: buildOptions,\n      configurations: {\n        development: {\n          mode: 'development',\n        },\n        production: {\n          mode: 'production',\n        },\n      },\n    };\n  }\n\n  updateProjectConfiguration(tree, options.project, project);\n}\n\nexport function addOrChangeServeTarget(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema,\n  target: string\n) {\n  const project = readProjectConfiguration(tree, options.project);\n\n  project.targets ??= {};\n\n  if (project.targets[target]) {\n    const serveTarget = project.targets[target];\n    const serveOptions: ViteDevServerExecutorOptions = {\n      buildTarget: `${options.project}:build`,\n      https: project.targets[target].options?.https,\n      hmr: project.targets[target].options?.hmr,\n      open: project.targets[target].options?.open,\n    };\n    if (serveTarget.executor === '@nxext/vite:dev') {\n      serveOptions.proxyConfig = project.targets[target].options.proxyConfig;\n    }\n    serveTarget.executor = '@nx/vite:dev-server';\n    serveTarget.options = serveOptions;\n  } else {\n    project.targets[target] = {\n      executor: '@nx/vite:dev-server',\n      defaultConfiguration: 'development',\n      options: {\n        buildTarget: `${options.project}:build`,\n      },\n      configurations: {\n        development: {\n          buildTarget: `${options.project}:build:development`,\n          hmr: true,\n        },\n        production: {\n          buildTarget: `${options.project}:build:production`,\n          hmr: false,\n        },\n      },\n    };\n  }\n\n  updateProjectConfiguration(tree, options.project, project);\n}\n\n/**\n * Adds a target for the preview server.\n *\n * @param tree\n * @param options\n * @param serveTarget An existing serve target.\n * @param previewTarget  The preview target to create.\n */\nexport function addPreviewTarget(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema,\n  serveTarget: string\n) {\n  const project = readProjectConfiguration(tree, options.project);\n\n  const previewOptions: VitePreviewServerExecutorOptions = {\n    buildTarget: `${options.project}:build`,\n  };\n\n  project.targets ??= {};\n\n  // Update the options from the passed serve target.\n  if (project.targets[serveTarget]) {\n    const target = project.targets[serveTarget];\n    if (target.executor === '@nxext/vite:dev') {\n      previewOptions.proxyConfig = target.options.proxyConfig;\n    }\n    previewOptions.https = target.options?.https;\n    previewOptions.open = target.options?.open;\n  }\n\n  // Adds a preview target.\n  project.targets.preview = {\n    executor: '@nx/vite:preview-server',\n    defaultConfiguration: 'development',\n    options: previewOptions,\n    configurations: {\n      development: {\n        buildTarget: `${options.project}:build:development`,\n      },\n      production: {\n        buildTarget: `${options.project}:build:production`,\n      },\n    },\n  };\n\n  updateProjectConfiguration(tree, options.project, project);\n}\n\nexport function editTsConfig(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema\n) {\n  const projectConfig = readProjectConfiguration(tree, options.project);\n\n  const config = readJson(tree, `${projectConfig.root}/tsconfig.json`);\n\n  const commonCompilerOptions = {\n    target: 'ESNext',\n    useDefineForClassFields: true,\n    module: 'ESNext',\n    strict: true,\n    moduleResolution: 'Node',\n    resolveJsonModule: true,\n    isolatedModules: true,\n    types: ['vite/client'],\n    noEmit: true,\n  };\n\n  switch (options.uiFramework) {\n    case 'react':\n      config.compilerOptions = {\n        ...commonCompilerOptions,\n        lib: ['DOM', 'DOM.Iterable', 'ESNext'],\n        allowJs: false,\n        esModuleInterop: false,\n        skipLibCheck: true,\n        allowSyntheticDefaultImports: true,\n        forceConsistentCasingInFileNames: true,\n        jsx: 'react-jsx',\n      };\n      config.include = [...config.include, 'src'];\n      break;\n    case 'none':\n      config.compilerOptions = {\n        ...commonCompilerOptions,\n        lib: ['ESNext', 'DOM'],\n        skipLibCheck: true,\n        esModuleInterop: true,\n        strict: true,\n        noUnusedLocals: true,\n        noUnusedParameters: true,\n        noImplicitReturns: true,\n      };\n      config.include = [...config.include, 'src'];\n      break;\n    default:\n      break;\n  }\n\n  writeJson(tree, `${projectConfig.root}/tsconfig.json`, config);\n}\n\nexport function deleteWebpackConfig(\n  tree: Tree,\n  projectRoot: string,\n  webpackConfigFilePath?: string\n) {\n  const webpackConfigPath =\n    webpackConfigFilePath && tree.exists(webpackConfigFilePath)\n      ? webpackConfigFilePath\n      : tree.exists(`${projectRoot}/webpack.config.js`)\n      ? `${projectRoot}/webpack.config.js`\n      : tree.exists(`${projectRoot}/webpack.config.ts`)\n      ? `${projectRoot}/webpack.config.ts`\n      : null;\n  if (webpackConfigPath) {\n    tree.delete(webpackConfigPath);\n  }\n}\n\nexport function moveAndEditIndexHtml(\n  tree: Tree,\n  options: ViteConfigurationGeneratorSchema,\n  buildTarget: string\n) {\n  const projectConfig = readProjectConfiguration(tree, options.project);\n\n  let indexHtmlPath =\n    projectConfig.targets?.[buildTarget]?.options?.index ??\n    `${projectConfig.root}/src/index.html`;\n  let mainPath =\n    projectConfig.targets?.[buildTarget]?.options?.main ??\n    `${projectConfig.root}/src/main.ts${\n      options.uiFramework === 'react' ? 'x' : ''\n    }`;\n\n  if (projectConfig.root !== '.') {\n    mainPath = mainPath.replace(projectConfig.root, '');\n  }\n\n  if (\n    !tree.exists(indexHtmlPath) &&\n    tree.exists(`${projectConfig.root}/index.html`)\n  ) {\n    indexHtmlPath = `${projectConfig.root}/index.html`;\n  }\n\n  if (tree.exists(indexHtmlPath)) {\n    const indexHtmlContent = tree.read(indexHtmlPath, 'utf8');\n    if (\n      !indexHtmlContent.includes(\n        `<script type='module' src='${mainPath}'></script>`\n      )\n    ) {\n      tree.write(\n        `${projectConfig.root}/index.html`,\n        indexHtmlContent.replace(\n          '</body>',\n          `<script type='module' src='${mainPath}'></script>\n          </body>`\n        )\n      );\n\n      if (tree.exists(`${projectConfig.root}/src/index.html`)) {\n        tree.delete(`${projectConfig.root}/src/index.html`);\n      }\n    }\n  } else {\n    tree.write(\n      `${projectConfig.root}/index.html`,\n      `<!DOCTYPE html>\n      <html lang='en'>\n        <head>\n          <meta charset='UTF-8' />\n          <link rel='icon' href='/favicon.ico' />\n          <meta name='viewport' content='width=device-width, initial-scale=1.0' />\n          <title>Vite</title>\n        </head>\n        <body>\n          <div id='root'></div>\n          <script type='module' src='${mainPath}'></script>\n        </body>\n      </html>`\n    );\n  }\n}\n\nexport interface ViteConfigFileOptions {\n  project: string;\n  includeLib?: boolean;\n  includeVitest?: boolean;\n  inSourceTests?: boolean;\n  testEnvironment?: 'node' | 'jsdom' | 'happy-dom' | 'edge-runtime' | string;\n  rollupOptionsExternalString?: string;\n  rollupOptionsExternal?: string[];\n  imports?: string[];\n  plugins?: string[];\n}\n\nexport function createOrEditViteConfig(\n  tree: Tree,\n  options: ViteConfigFileOptions,\n  onlyVitest: boolean,\n  projectAlreadyHasViteTargets?: TargetFlags\n) {\n  const projectConfig = readProjectConfiguration(tree, options.project);\n\n  const viteConfigPath = `${projectConfig.root}/vite.config.ts`;\n\n  const buildOption = onlyVitest\n    ? ''\n    : options.includeLib\n    ? `\n      // Configuration for building your library.\n      // See: https://vitejs.dev/guide/build.html#library-mode\n      build: {\n        lib: {\n          // Could also be a dictionary or array of multiple entry points.\n          entry: 'src/index.ts',\n          name: '${options.project}',\n          fileName: 'index',\n          // Change this to the formats you want to support.\n          // Don't forget to update your package.json as well.\n          formats: ['es', 'cjs']\n        },\n        rollupOptions: {\n          // External packages that should not be bundled into your library.\n          external: [${options.rollupOptionsExternal ?? ''}]\n        }\n      },`\n    : ``;\n\n  const imports: string[] = options.imports ? options.imports : [];\n\n  if (!onlyVitest && options.includeLib) {\n    imports.push(\n      `import dts from 'vite-plugin-dts'`,\n      `import * as path from 'path'`\n    );\n  }\n\n  let viteConfigContent = '';\n\n  const plugins = options.plugins\n    ? [...options.plugins, `nxViteTsPaths()`]\n    : [`nxViteTsPaths()`];\n\n  if (!onlyVitest && options.includeLib) {\n    plugins.push(\n      `dts({ entryRoot: 'src', tsConfigFilePath: path.join(__dirname, 'tsconfig.lib.json'), skipDiagnostics: true })`\n    );\n  }\n\n  const testOption = options.includeVitest\n    ? `test: {\n    globals: true,\n    cache: {\n      dir: '${offsetFromRoot(projectConfig.root)}node_modules/.vitest'\n    },\n    environment: '${options.testEnvironment ?? 'jsdom'}',\n    include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],\n    ${\n      options.inSourceTests\n        ? `includeSource: ['src/**/*.{js,mjs,cjs,ts,mts,cts,jsx,tsx}']`\n        : ''\n    }\n  },`\n    : '';\n\n  const defineOption = options.inSourceTests\n    ? `define: {\n    'import.meta.vitest': undefined\n  },`\n    : '';\n\n  const devServerOption = onlyVitest\n    ? ''\n    : options.includeLib\n    ? ''\n    : `\n    server:{\n      port: 4200,\n      host: 'localhost',\n    },`;\n\n  const previewServerOption = onlyVitest\n    ? ''\n    : options.includeLib\n    ? ''\n    : `\n    preview:{\n      port: 4300,\n      host: 'localhost',\n    },`;\n\n  const workerOption = `\n    // Uncomment this if you are using workers. \n    // worker: {\n    //  plugins: [ nxViteTsPaths() ],\n    // },`;\n\n  const cacheDir = `cacheDir: '${offsetFromRoot(\n    projectConfig.root\n  )}node_modules/.vite/${options.project}',`;\n\n  if (tree.exists(viteConfigPath)) {\n    handleViteConfigFileExists(\n      tree,\n      viteConfigPath,\n      options,\n      buildOption,\n      imports,\n      plugins,\n      testOption,\n      cacheDir,\n      offsetFromRoot(projectConfig.root),\n      projectAlreadyHasViteTargets\n    );\n    return;\n  }\n\n  viteConfigContent = `\n      /// <reference types='vitest' />\n      import { defineConfig } from 'vite';\n      ${imports.join(';\\n')}${imports.length ? ';' : ''}\n      import { nxViteTsPaths } from '@nx/vite/plugins/nx-tsconfig-paths.plugin';\n      \n      export default defineConfig({\n        ${cacheDir}\n        ${devServerOption}\n        ${previewServerOption}\n        \n        plugins: [${plugins.join(',\\n')}],\n        ${workerOption}\n        ${buildOption}\n        ${defineOption}\n        ${testOption}\n      });`;\n\n  tree.write(viteConfigPath, viteConfigContent);\n}\n\nexport function normalizeViteConfigFilePathWithTree(\n  tree: Tree,\n  projectRoot: string,\n  configFile?: string\n): string {\n  return configFile && tree.exists(configFile)\n    ? configFile\n    : tree.exists(joinPathFragments(`${projectRoot}/vite.config.ts`))\n    ? joinPathFragments(`${projectRoot}/vite.config.ts`)\n    : tree.exists(joinPathFragments(`${projectRoot}/vite.config.js`))\n    ? joinPathFragments(`${projectRoot}/vite.config.js`)\n    : undefined;\n}\n\nexport function getViteConfigPathForProject(\n  tree: Tree,\n  projectName: string,\n  target?: string\n) {\n  let viteConfigPath: string | undefined;\n  const { targets, root } = readProjectConfiguration(tree, projectName);\n  if (target) {\n    viteConfigPath = targets?.[target]?.options?.configFile;\n  } else {\n    const config = Object.values(targets).find(\n      (config) =>\n        config.executor === '@nrwl/nx:build' ||\n        config.executor === '@nrwl/vite:build'\n    );\n    viteConfigPath = config?.options?.configFile;\n  }\n\n  return normalizeViteConfigFilePathWithTree(tree, root, viteConfigPath);\n}\n\nexport async function handleUnsupportedUserProvidedTargets(\n  userProvidedTargetIsUnsupported: TargetFlags,\n  userProvidedTargetName: UserProvidedTargetName,\n  validFoundTargetName: ValidFoundTargetName\n) {\n  if (userProvidedTargetIsUnsupported.build && validFoundTargetName.build) {\n    await handleUnsupportedUserProvidedTargetsErrors(\n      userProvidedTargetName.build,\n      validFoundTargetName.build,\n      'build',\n      'build'\n    );\n  }\n\n  if (userProvidedTargetIsUnsupported.serve && validFoundTargetName.serve) {\n    await handleUnsupportedUserProvidedTargetsErrors(\n      userProvidedTargetName.serve,\n      validFoundTargetName.serve,\n      'serve',\n      'dev-server'\n    );\n  }\n\n  if (userProvidedTargetIsUnsupported.test && validFoundTargetName.test) {\n    await handleUnsupportedUserProvidedTargetsErrors(\n      userProvidedTargetName.test,\n      validFoundTargetName.test,\n      'test',\n      'test'\n    );\n  }\n}\n\nasync function handleUnsupportedUserProvidedTargetsErrors(\n  userProvidedTargetName: string,\n  validFoundTargetName: string,\n  target: Target,\n  executor: 'build' | 'dev-server' | 'test'\n) {\n  logger.warn(\n    `The custom ${target} target you provided (${userProvidedTargetName}) cannot be converted to use the @nx/vite:${executor} executor.\n     However, we found the following ${target} target in your project that can be converted: ${validFoundTargetName}\n\n     Please note that converting a potentially non-compatible project to use Vite.js may result in unexpected behavior. Always commit\n     your changes before converting a project to use Vite.js, and test the converted project thoroughly before deploying it.\n    `\n  );\n  const { Confirm } = require('enquirer');\n  const prompt = new Confirm({\n    name: 'question',\n    message: `Should we convert the ${validFoundTargetName} target to use the @nx/vite:${executor} executor?`,\n    initial: true,\n  });\n  const shouldConvert = await prompt.run();\n  if (!shouldConvert) {\n    throw new Error(\n      `The ${target} target ${userProvidedTargetName} cannot be converted to use the @nx/vite:${executor} executor.\n      Please try again, either by providing a different ${target} target or by not providing a target at all (Nx will\n        convert the first one it finds, most probably this one: ${validFoundTargetName})\n\n      Please note that converting a potentially non-compatible project to use Vite.js may result in unexpected behavior. Always commit\n      your changes before converting a project to use Vite.js, and test the converted project thoroughly before deploying it.\n      `\n    );\n  }\n}\n\nexport async function handleUnknownExecutors(projectName: string) {\n  logger.warn(\n    `\n      We could not find any targets in project ${projectName} that use executors which \n      can be converted to the @nx/vite executors.\n\n      This either means that your project may not have a target \n      for building, serving, or testing at all, or that your targets are \n      using executors that are not known to Nx.\n      \n      If you still want to convert your project to use the @nx/vite executors,\n      please make sure to commit your changes before running this generator.\n      `\n  );\n\n  const { Confirm } = require('enquirer');\n  const prompt = new Confirm({\n    name: 'question',\n    message: `Should Nx convert your project to use the @nx/vite executors?`,\n    initial: true,\n  });\n  const shouldConvert = await prompt.run();\n  if (!shouldConvert) {\n    throw new Error(`\n      Nx could not verify that the executors you are using can be converted to the @nx/vite executors.\n      Please try again with a different project.\n    `);\n  }\n}\n\nfunction handleViteConfigFileExists(\n  tree: Tree,\n  viteConfigPath: string,\n  options: ViteConfigFileOptions,\n  buildOption: string,\n  imports: string[],\n  plugins: string[],\n  testOption: string,\n  cacheDir: string,\n  offsetFromRoot: string,\n  projectAlreadyHasViteTargets?: TargetFlags\n) {\n  if (\n    projectAlreadyHasViteTargets?.build &&\n    projectAlreadyHasViteTargets?.test\n  ) {\n    return;\n  }\n\n  if (process.env.NX_VERBOSE_LOGGING === 'true') {\n    logger.info(\n      `vite.config.ts already exists for project ${options.project}.`\n    );\n  }\n\n  const buildOptionObject = {\n    lib: {\n      entry: 'src/index.ts',\n      name: options.project,\n      fileName: 'index',\n      formats: ['es', 'cjs'],\n    },\n    rollupOptions: {\n      external: options.rollupOptionsExternal ?? [],\n    },\n  };\n\n  const testOptionObject = {\n    globals: true,\n    cache: {\n      dir: `${offsetFromRoot}node_modules/.vitest`,\n    },\n    environment: 'jsdom',\n    include: ['src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],\n  };\n\n  const changed = ensureViteConfigIsCorrect(\n    tree,\n    viteConfigPath,\n    buildOption,\n    buildOptionObject,\n    imports,\n    plugins,\n    testOption,\n    testOptionObject,\n    cacheDir,\n    projectAlreadyHasViteTargets ?? {}\n  );\n\n  if (!changed) {\n    logger.warn(\n      `Make sure the following setting exists in your Vite configuration file (${viteConfigPath}):\n        \n        ${buildOption}\n        \n        `\n    );\n  }\n}\n"],"names":["findExistingTargetsInProject","addOrChangeTestTarget","addOrChangeBuildTarget","addOrChangeServeTarget","addPreviewTarget","editTsConfig","deleteWebpackConfig","moveAndEditIndexHtml","createOrEditViteConfig","normalizeViteConfigFilePathWithTree","getViteConfigPathForProject","handleUnsupportedUserProvidedTargets","handleUnknownExecutors","targets","userProvidedTargets","output","validFoundTargetName","projectContainsUnsupportedExecutor","userProvidedTargetIsUnsupported","alreadyHasNxViteTargets","supportedExecutors","build","serve","test","unsupportedExecutors","checkUserProvidedTarget","target","includes","executor","hasViteTargets","executorName","preview","foundTargets","tree","options","project","readProjectConfiguration","coveragePath","joinPathFragments","root","testOptions","passWithNoTests","reportsDirectory","offsetFromRoot","jestConfig","outputs","updateProjectConfiguration","buildOptions","outputPath","fileReplacements","base","baseHref","sourcemap","sourcemaps","defaultConfiguration","configurations","development","mode","production","serveTarget","serveOptions","buildTarget","https","hmr","open","proxyConfig","previewOptions","projectConfig","config","readJson","commonCompilerOptions","useDefineForClassFields","module","strict","moduleResolution","resolveJsonModule","isolatedModules","types","noEmit","uiFramework","compilerOptions","lib","allowJs","esModuleInterop","skipLibCheck","allowSyntheticDefaultImports","forceConsistentCasingInFileNames","jsx","include","noUnusedLocals","noUnusedParameters","noImplicitReturns","writeJson","projectRoot","webpackConfigFilePath","webpackConfigPath","exists","delete","indexHtmlPath","index","mainPath","main","replace","indexHtmlContent","read","write","onlyVitest","projectAlreadyHasViteTargets","viteConfigPath","buildOption","includeLib","rollupOptionsExternal","imports","push","viteConfigContent","plugins","testOption","includeVitest","testEnvironment","inSourceTests","defineOption","devServerOption","previewServerOption","workerOption","cacheDir","handleViteConfigFileExists","join","length","configFile","undefined","projectName","Object","values","find","userProvidedTargetName","handleUnsupportedUserProvidedTargetsErrors","logger","warn","Confirm","require","prompt","name","message","initial","shouldConvert","run","Error","process","env","NX_VERBOSE_LOGGING","info","buildOptionObject","entry","fileName","formats","rollupOptions","external","testOptionObject","globals","cache","dir","environment","changed","ensureViteConfigIsCorrect"],"mappings":"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"}