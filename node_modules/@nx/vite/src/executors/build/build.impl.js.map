{"version":3,"sources":["../../../../../../packages/vite/src/executors/build/build.impl.ts"],"sourcesContent":["import {\n  detectPackageManager,\n  ExecutorContext,\n  logger,\n  stripIndents,\n  writeJsonFile,\n} from '@nx/devkit';\nimport { build, InlineConfig, mergeConfig } from 'vite';\nimport {\n  getProjectTsConfigPath,\n  getViteBuildOptions,\n  getViteSharedConfig,\n} from '../../utils/options-utils';\nimport { ViteBuildExecutorOptions } from './schema';\nimport {\n  copyAssets,\n  createLockFile,\n  createPackageJson,\n  getLockFileName,\n} from '@nx/js';\nimport { existsSync, writeFileSync } from 'fs';\nimport { resolve } from 'path';\nimport { createAsyncIterable } from '@nx/devkit/src/utils/async-iterable';\nimport {\n  createBuildableTsConfig,\n  validateTypes,\n} from '../../utils/executor-utils';\n\nexport async function* viteBuildExecutor(\n  options: ViteBuildExecutorOptions,\n  context: ExecutorContext\n) {\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n\n  createBuildableTsConfig(projectRoot, options, context);\n\n  const normalizedOptions = normalizeOptions(options);\n\n  const buildConfig = mergeConfig(\n    getViteSharedConfig(normalizedOptions, false, context),\n    {\n      build: getViteBuildOptions(normalizedOptions, context),\n    }\n  );\n\n  if (!options.skipTypeCheck) {\n    await validateTypes({\n      workspaceRoot: context.root,\n      projectRoot: projectRoot,\n      tsconfig: getProjectTsConfigPath(projectRoot),\n    });\n  }\n\n  const watcherOrOutput = await runInstance(buildConfig);\n\n  const libraryPackageJson = resolve(projectRoot, 'package.json');\n  const rootPackageJson = resolve(context.root, 'package.json');\n  const distPackageJson = resolve(normalizedOptions.outputPath, 'package.json');\n\n  // Generate a package.json if option has been set.\n  if (options.generatePackageJson) {\n    if (context.projectGraph.nodes[context.projectName].type !== 'app') {\n      logger.warn(\n        stripIndents`The project ${context.projectName} is using the 'generatePackageJson' option which is deprecated for library projects. It should only be used for applications.\n        For libraries, configure the project to use the '@nx/dependency-checks' ESLint rule instead (https://nx.dev/packages/eslint-plugin/documents/dependency-checks).`\n      );\n    }\n\n    const builtPackageJson = createPackageJson(\n      context.projectName,\n      context.projectGraph,\n      {\n        target: context.targetName,\n        root: context.root,\n        isProduction: !options.includeDevDependenciesInPackageJson, // By default we remove devDependencies since this is a production build.\n      }\n    );\n\n    builtPackageJson.type = 'module';\n\n    writeJsonFile(`${options.outputPath}/package.json`, builtPackageJson);\n    const packageManager = detectPackageManager(context.root);\n\n    const lockFile = createLockFile(\n      builtPackageJson,\n      context.projectGraph,\n      packageManager\n    );\n    writeFileSync(\n      `${options.outputPath}/${getLockFileName(packageManager)}`,\n      lockFile,\n      {\n        encoding: 'utf-8',\n      }\n    );\n  }\n  // For buildable libs, copy package.json if it exists.\n  else if (\n    !existsSync(distPackageJson) &&\n    existsSync(libraryPackageJson) &&\n    rootPackageJson !== libraryPackageJson\n  ) {\n    await copyAssets(\n      {\n        outputPath: normalizedOptions.outputPath,\n        assets: [\n          {\n            input: projectRoot,\n            output: '.',\n            glob: 'package.json',\n          },\n        ],\n      },\n      context\n    );\n  }\n\n  if ('on' in watcherOrOutput) {\n    const iterable = createAsyncIterable<{ success: boolean }>(({ next }) => {\n      let success = true;\n      watcherOrOutput.on('event', (event) => {\n        if (event.code === 'START') {\n          success = true;\n        } else if (event.code === 'ERROR') {\n          success = false;\n        } else if (event.code === 'END') {\n          next({ success });\n        }\n        // result must be closed when present.\n        // see https://rollupjs.org/guide/en/#rollupwatch\n        if ('result' in event) {\n          event.result.close();\n        }\n      });\n    });\n    yield* iterable;\n  } else {\n    const output = watcherOrOutput?.['output'] || watcherOrOutput?.[0]?.output;\n    const fileName = output?.[0]?.fileName || 'main.cjs';\n    const outfile = resolve(normalizedOptions.outputPath, fileName);\n    yield { success: true, outfile };\n  }\n}\n\nfunction runInstance(options: InlineConfig) {\n  return build({\n    ...options,\n  });\n}\n\nfunction normalizeOptions(options: ViteBuildExecutorOptions) {\n  const normalizedOptions = { ...options };\n\n  // coerce watch to null or {} to match with Vite's watch config\n  if (options.watch === false) {\n    normalizedOptions.watch = null;\n  } else if (options.watch === true) {\n    normalizedOptions.watch = {};\n  }\n\n  return normalizedOptions;\n}\n\nexport default viteBuildExecutor;\n"],"names":["viteBuildExecutor","options","context","projectRoot","projectsConfigurations","projects","projectName","root","createBuildableTsConfig","normalizedOptions","normalizeOptions","buildConfig","mergeConfig","getViteSharedConfig","build","getViteBuildOptions","skipTypeCheck","validateTypes","workspaceRoot","tsconfig","getProjectTsConfigPath","watcherOrOutput","runInstance","libraryPackageJson","resolve","rootPackageJson","distPackageJson","outputPath","generatePackageJson","projectGraph","nodes","type","logger","warn","stripIndents","builtPackageJson","createPackageJson","target","targetName","isProduction","includeDevDependenciesInPackageJson","writeJsonFile","packageManager","detectPackageManager","lockFile","createLockFile","writeFileSync","getLockFileName","encoding","existsSync","copyAssets","assets","input","output","glob","iterable","createAsyncIterable","next","success","on","event","code","result","close","fileName","outfile","watch"],"mappings":"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"}